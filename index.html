<!doctype html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="manifest.json" />
  <title>é™„è¿‘å·´å£«ç«™åˆ°ç«™æ™‚é–“ (KMB)</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --muted:#9bb0d0; --text:#eaf0ff;
      --accent:#4da3ff; --good:#3ddc97; --warn:#ffcc66; --bad:#ff6b6b;
      --border:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans HK",sans-serif;
      background:linear-gradient(180deg,#070b14 0%, #0b1220 30%, #070b14 100%);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(11,18,32,.85);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--border);
      padding:14px 14px 10px;
    }
    h1{font-size:16px; margin:0 0 8px; letter-spacing:.2px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      padding:8px 10px; border-radius:12px;
      color:var(--text); font-size:13px;
      display:flex; gap:8px; align-items:center;
    }
    select,button{
      background:transparent; border:0; color:var(--text);
      font-size:13px; outline:none;
    }
    button{
      cursor:pointer;
    }
    main{padding:12px 14px 80px}
    .status{
      color:var(--muted); font-size:13px; line-height:1.4;
      margin:10px 0 12px;
    }
    .grid{
      display:grid; gap:12px;
    }
    .card{
      background:rgba(17,26,46,.9);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .cardTop{
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
      margin-bottom:8px;
    }
    .stopName{font-size:15px; font-weight:700; margin:0}
    .meta{color:var(--muted); font-size:12px; margin-top:4px}
    .dist{
      font-size:12px; color:var(--muted);
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      white-space:nowrap;
    }
    .routes{display:grid; gap:8px; margin-top:10px}
    .routeRow{
      display:grid;
      grid-template-columns: 64px 1fr 78px 78px;
      gap:10px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:12px;
      background:rgba(255,255,255,.03);
      align-items:center;
    }
    .routeNo{
      font-weight:800; font-size:15px;
      color:var(--accent);
    }
    .dest{
      font-size:12px; color:var(--muted);
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .etaBox{
      text-align:right;
      font-variant-numeric:tabular-nums;
    }
    .etaMin{font-size:14px; font-weight:800}
    .etaAbs{font-size:11px; color:var(--muted)}
    .tag{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      font-size:11px; color:var(--muted);
      margin-top:6px;
    }
    .btnSmall{
      padding:6px 10px; border-radius:10px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
    }
    .footer{
      position:fixed; bottom:0; left:0; right:0;
      padding:10px 14px;
      border-top:1px solid var(--border);
      background:rgba(11,18,32,.85);
      backdrop-filter:blur(10px);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      color:var(--muted); font-size:12px;
    }
    .dot{
      width:8px; height:8px; border-radius:50%;
      background:var(--warn);
      box-shadow:0 0 0 4px rgba(255,204,102,.15);
      display:inline-block;
    }
    .dot.good{background:var(--good); box-shadow:0 0 0 4px rgba(61,220,151,.15)}
    .dot.bad{background:var(--bad); box-shadow:0 0 0 4px rgba(255,107,107,.15)}
  </style>
</head>
<body>
<header>
  <h1>é™„è¿‘ KMB å·´å£«ç«™ï¼šåˆ°ç«™æ™‚é–“ï¼ˆé¡¯ç¤ºä¸‹ä¸€ç­ + ä¹‹å¾Œä¸€ç­ï¼‰</h1>
  <div class="row">
    <div class="pill">
      è·é›¢
      <select id="radius">
        <option value="150">150m</option>
        <option value="300" selected>300m</option>
        <option value="500">500m</option>
        <option value="800">800m</option>
      </select>
    </div>
    <div class="pill">
      æ›´æ–°
      <select id="refreshSec">
        <option value="15">15s</option>
        <option value="20" selected>20s</option>
        <option value="30">30s</option>
        <option value="60">60s</option>
      </select>
    </div>
    <div class="pill">
      é¡¯ç¤º
      <select id="lang">
        <option value="tc" selected>ç¹ä¸­</option>
        <option value="en">EN</option>
      </select>
    </div>
    <div class="pill">
      <button id="btnLocate">ğŸ“ é‡æ–°å®šä½</button>
    </div>
    <div class="pill">
      <button id="btnRefresh" class="btnSmall">âŸ³ ç«‹å³æ›´æ–°</button>
    </div>
  </div>
</header>

<main>
  <div class="status" id="status">åˆå§‹åŒ–ä¸­â€¦</div>
  <div class="grid" id="list"></div>
</main>

<div class="footer">
  <div><span id="netDot" class="dot"></span> <span id="netText">æª¢æŸ¥ç¶²çµ¡â€¦</span></div>
  <div id="lastUpdated">Last: --</div>
</div>

<script>
(() => {
  const API_BASE = "https://data.etabus.gov.hk/v1/transport/kmb"; // endpoints grounded by your doc: /stop, /stop-eta/{stop_id} [1](https://vtcstaff-my.sharepoint.com/personal/mattkung_vtc_edu_hk/_layouts/15/Doc.aspx?sourcedoc=%7B2384F943-553C-429E-B39F-4023C6CFD2CB%7D&file=KMB%20Bus%20API.docx&action=default&mobileredirect=true&DefaultItemOpen=1)
  const elStatus = document.getElementById("status");
  const elList = document.getElementById("list");
  const elRadius = document.getElementById("radius");
  const elRefreshSec = document.getElementById("refreshSec");
  const elLang = document.getElementById("lang");
  const elLast = document.getElementById("lastUpdated");
  const elNetDot = document.getElementById("netDot");
  const elNetText = document.getElementById("netText");
  const btnLocate = document.getElementById("btnLocate");
  const btnRefresh = document.getElementById("btnRefresh");

  let myPos = null;
  let stops = null;            // array
  let timer = null;
  let inFlight = new Map();    // stopId -> AbortController

  // ---------- Simple IndexedDB blob cache (stores stop list) ----------
  const DB_NAME = "kmb_pwa_db";
  const DB_VER = 1;
  const STORE = "kv";
  function openDB(){
    return new Promise((res, rej) => {
      const req = indexedDB.open(DB_NAME, DB_VER);
      req.onupgradeneeded = () => req.result.createObjectStore(STORE);
      req.onsuccess = () => res(req.result);
      req.onerror = () => rej(req.error);
    });
  }
  async function idbGet(key){
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction(STORE, "readonly");
      const st = tx.objectStore(STORE);
      const req = st.get(key);
      req.onsuccess = () => res(req.result);
      req.onerror = () => rej(req.error);
    });
  }
  async function idbSet(key, val){
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction(STORE, "readwrite");
      tx.objectStore(STORE).put(val, key);
      tx.oncomplete = () => res(true);
      tx.onerror = () => rej(tx.error);
    });
  }

  // ---------- Utilities ----------
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  function fmtDist(m){
    if (m < 1000) return `${Math.round(m)}m`;
    return `${(m/1000).toFixed(2)}km`;
  }
  function haversineMeters(lat1, lon1, lat2, lon2){
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 +
              Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2 * R * Math.asin(Math.sqrt(a));
  }
  function nowISO(){
    return new Date().toISOString();
  }
  function etaToMin(etaIso){
    if (!etaIso) return null;
    const t = Date.parse(etaIso);
    if (Number.isNaN(t)) return null;
    const diff = Math.round((t - Date.now())/60000);
    return diff;
  }
  function fmtEtaMin(min){
    if (min === null) return "--";
    if (min <= 0) return "åˆ°ç«™";
    return `${min} åˆ†`;
  }
  function fmtAbsTime(etaIso){
    if (!etaIso) return "--";
    const d = new Date(etaIso);
    if (Number.isNaN(d.getTime())) return "--";
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
  }

  // Network indicator
  function updateNet(){
    const ok = navigator.onLine;
    elNetDot.className = "dot " + (ok ? "good" : "bad");
    elNetText.textContent = ok ? "Online" : "Offline";
  }
  window.addEventListener("online", updateNet);
  window.addEventListener("offline", updateNet);
  updateNet();

  // ---------- Fetch helpers with timeout ----------
  async function fetchJSON(url, {timeoutMs=12000, signal} = {}){
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort("timeout"), timeoutMs);
    const mergedSignal = signal ? anySignal([signal, ctrl.signal]) : ctrl.signal;

    try{
      const r = await fetch(url, {signal: mergedSignal});
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    } finally {
      clearTimeout(t);
    }
  }
  function anySignal(signals){
    const ctrl = new AbortController();
    const onAbort = (e) => ctrl.abort(e?.target?.reason || "aborted");
    signals.forEach(s => s && s.addEventListener("abort", onAbort, {once:true}));
    return ctrl.signal;
  }

  // ---------- Load stop list (cached) ----------
  async function loadStops(){
    elStatus.textContent = "ä¸‹è¼‰/è®€å–å·´å£«ç«™è³‡æ–™ä¸­â€¦";
    const cached = await idbGet("stops_blob");
    const cachedAt = await idbGet("stops_cached_at");

    // Refresh cache every 7 days (safe default)
    const needRefresh = !cached || !cachedAt || (Date.now() - cachedAt) > 7*24*3600*1000;

    if (cached && !needRefresh){
      stops = cached;
      elStatus.textContent = `å·²è®€å–å¿«å–ï¼š${stops.length} å€‹å·´å£«ç«™`;
      return;
    }

    // Fetch live stop list: /stop [1](https://vtcstaff-my.sharepoint.com/personal/mattkung_vtc_edu_hk/_layouts/15/Doc.aspx?sourcedoc=%7B2384F943-553C-429E-B39F-4023C6CFD2CB%7D&file=KMB%20Bus%20API.docx&action=default&mobileredirect=true&DefaultItemOpen=1)
    const url = `${API_BASE}/stop`;
    try{
      const js = await fetchJSON(url);
      // We do defensive extraction; API usually returns {data:[...]}
      const arr = Array.isArray(js?.data) ? js.data : [];
      if (!arr.length) throw new Error("Stop list empty");
      stops = arr;
      await idbSet("stops_blob", stops);
      await idbSet("stops_cached_at", Date.now());
      elStatus.textContent = `å·²æ›´æ–°å·´å£«ç«™è³‡æ–™ï¼š${stops.length} å€‹`;
    } catch(e){
      if (cached){
        stops = cached;
        elStatus.textContent = `ç¶²çµ¡/æ¥å£å•é¡Œï¼Œæ”¹ç”¨èˆŠå¿«å–ï¼ˆ${stops.length} å€‹å·´å£«ç«™ï¼‰`;
      } else {
        throw e;
      }
    }
  }

  // ---------- GPS ----------
  function locate(){
    elStatus.textContent = "æ­£åœ¨å®šä½â€¦ï¼ˆè«‹å…è¨±ä½ç½®æ¬Šé™ï¼‰";
    return new Promise((res, rej) => {
      if (!navigator.geolocation) return rej(new Error("No geolocation"));
      navigator.geolocation.getCurrentPosition(
        p => {
          myPos = {lat: p.coords.latitude, lon: p.coords.longitude, acc: p.coords.accuracy};
          res(myPos);
        },
        err => rej(err),
        {enableHighAccuracy:true, timeout:12000, maximumAge:8000}
      );
    });
  }

  // ---------- Find nearby stops ----------
  function getNearbyStops(){
    const r = Number(elRadius.value);
    const lang = elLang.value;
    if (!myPos || !stops) return [];

    const near = [];
    for (const s of stops){
      // Defensive fields (stop list commonly includes lat/long)
      const lat = Number(s.lat ?? s.latitude);
      const lon = Number(s.long ?? s.longitude ?? s.lng);
      const id  = s.stop ?? s.stop_id ?? s.stopId;
      if (!id || !Number.isFinite(lat) || !Number.isFinite(lon)) continue;
      const d = haversineMeters(myPos.lat, myPos.lon, lat, lon);
      if (d <= r){
        const name = (lang === "tc" ? (s.name_tc ?? s.name ?? id) : (s.name_en ?? s.name ?? id));
        near.push({id, name, d, raw:s});
      }
    }
    near.sort((a,b)=>a.d-b.d);
    return near.slice(0, 8); // show top 8 closest
  }

  // ---------- Fetch ETA for a stop ----------
  async function loadStopETA(stopId){
    // Abort previous in-flight request for this stop
    if (inFlight.has(stopId)){
      inFlight.get(stopId).abort("replaced");
      inFlight.delete(stopId);
    }
    const ctrl = new AbortController();
    inFlight.set(stopId, ctrl);

    // ETA by stop: /stop-eta/{stop_id} [1](https://vtcstaff-my.sharepoint.com/personal/mattkung_vtc_edu_hk/_layouts/15/Doc.aspx?sourcedoc=%7B2384F943-553C-429E-B39F-4023C6CFD2CB%7D&file=KMB%20Bus%20API.docx&action=default&mobileredirect=true&DefaultItemOpen=1)
    const url = `${API_BASE}/stop-eta/${encodeURIComponent(stopId)}`;

    try{
      const js = await fetchJSON(url, {timeoutMs:12000, signal: ctrl.signal});
      const arr = Array.isArray(js?.data) ? js.data : [];
      return arr;
    } finally {
      inFlight.delete(stopId);
    }
  }

  // ---------- Convert ETA data -> next 2 arrivals per route ----------
  function normalizeETAList(etaArr){
    // We do NOT assume strict schema; we defensively read common fields.
    // Group key: route + (direction) + service_type + dest
    const groups = new Map();

    for (const x of etaArr){
      const route = x.route ?? x.route_no ?? x.routeNo;
      if (!route) continue;

      const dir = x.dir ?? x.direction ?? "";
      const svc = String(x.service_type ?? x.serviceType ?? "");
      const dest = (elLang.value === "tc")
        ? (x.dest_tc ?? x.destination_tc ?? x.dest ?? "")
        : (x.dest_en ?? x.destination_en ?? x.dest ?? "");
      const eta = x.eta ?? x.eta_time ?? x.etaTime;
      const seq = x.seq ?? x.sequence ?? null;

      const key = `${route}|${dir}|${svc}|${dest}`;
      if (!groups.has(key)) groups.set(key, []);
      groups.get(key).push({route, dir, svc, dest, eta, seq});
    }

    const rows = [];
    for (const [key, items] of groups.entries()){
      // Sort by ETA time
      items.sort((a,b)=> (Date.parse(a.eta)||1e18) - (Date.parse(b.eta)||1e18));
      const a1 = items[0] || null;
      const a2 = items[1] || null;
      const m1 = a1 ? etaToMin(a1.eta) : null;
      rows.push({
        route: a1?.route ?? key.split("|")[0],
        dest: a1?.dest ?? "",
        dir: a1?.dir ?? "",
        svc: a1?.svc ?? "",
        eta1: a1?.eta ?? null,
        eta2: a2?.eta ?? null,
        min1: m1
      });
    }

    // Sort routes by soonest arrival
    rows.sort((a,b)=> (a.min1 ?? 1e9) - (b.min1 ?? 1e9));
    return rows;
  }

  // ---------- Render ----------
  function renderSkeleton(nearby){
    elList.innerHTML = "";
    if (!nearby.length){
      elList.innerHTML = `<div class="card">é™„è¿‘ ${elRadius.value}m å…§æ‰¾ä¸åˆ°å·´å£«ç«™ï¼ˆè©¦ä¸‹åŠ å¤§è·é›¢ï¼‰</div>`;
      return;
    }

    for (const s of nearby){
      const card = document.createElement("div");
      card.className = "card";
      card.id = `stop_${s.id}`;
      card.innerHTML = `
        <div class="cardTop">
          <div>
            <p class="stopName">${escapeHtml(s.name)}</p>
            <div class="meta">Stop ID: ${escapeHtml(s.id)} Â· GPS Â±${Math.round(myPos.acc)}m</div>
            <div class="tag">å°‡é¡¯ç¤ºï¼šæ¯æ¢ç·šã€Œä¸‹ä¸€ç­ + ä¹‹å¾Œä¸€ç­ã€</div>
          </div>
          <div class="dist">${fmtDist(s.d)}</div>
        </div>
        <div class="routes" id="routes_${s.id}">
          <div class="routeRow">
            <div class="routeNo">â€¦</div>
            <div class="dest">è®€å–åˆ°ç«™æ™‚é–“ä¸­â€¦</div>
            <div class="etaBox"><div class="etaMin">--</div><div class="etaAbs">--</div></div>
            <div class="etaBox"><div class="etaMin">--</div><div class="etaAbs">--</div></div>
          </div>
        </div>
      `;
      elList.appendChild(card);
    }
  }

  function renderStopRoutes(stopId, rows){
    const box = document.getElementById(`routes_${stopId}`);
    if (!box) return;

    if (!rows.length){
      box.innerHTML = `<div class="routeRow">
        <div class="routeNo">--</div>
        <div class="dest">æš«æ™‚æ²’æœ‰åˆ°ç«™è³‡æ–™</div>
        <div class="etaBox"><div class="etaMin">--</div><div class="etaAbs">--</div></div>
        <div class="etaBox"><div class="etaMin">--</div><div class="etaAbs">--</div></div>
      </div>`;
      return;
    }

    box.innerHTML = rows.slice(0, 12).map(r => {
      const m1 = etaToMin(r.eta1);
      const m2 = etaToMin(r.eta2);
      return `
        <div class="routeRow">
          <div class="routeNo">${escapeHtml(r.route)}</div>
          <div class="dest">${escapeHtml(r.dest || "")}</div>
          <div class="etaBox">
            <div class="etaMin">${fmtEtaMin(m1)}</div>
            <div class="etaAbs">${fmtAbsTime(r.eta1)}</div>
          </div>
          <div class="etaBox">
            <div class="etaMin">${fmtEtaMin(m2)}</div>
            <div class="etaAbs">${fmtAbsTime(r.eta2)}</div>
          </div>
        </div>
      `;
    }).join("");
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // ---------- Main refresh loop ----------
  async function refreshAll(){
    if (!myPos || !stops) return;

    const nearby = getNearbyStops();
    renderSkeleton(nearby);
    elStatus.textContent = `æ‰¾åˆ° ${nearby.length} å€‹é™„è¿‘å·´å£«ç«™ï¼ˆ${elRadius.value}m å…§ï¼‰`;

    // Load ETA for each stop (sequential to avoid spamming)
    for (const s of nearby){
      try{
        const etaArr = await loadStopETA(s.id);
        const rows = normalizeETAList(etaArr);
        renderStopRoutes(s.id, rows);
        await sleep(120); // small gap
      } catch(e){
        renderStopRoutes(s.id, []);
      }
    }

    elLast.textContent = "Last: " + new Date().toLocaleTimeString("zh-HK", {hour:"2-digit", minute:"2-digit", second:"2-digit"});
  }

  function startTimer(){
    if (timer) clearInterval(timer);
    const sec = Number(elRefreshSec.value);
    timer = setInterval(() => refreshAll(), sec * 1000);
  }

  // ---------- Init ----------
  async function init(){
    try{
      await loadStops();
      await locate();
      startTimer();
      await refreshAll();
    } catch(e){
      elStatus.textContent = "å•Ÿå‹•å¤±æ•—ï¼šè«‹ç¢ºèªå·²å…è¨±ä½ç½®æ¬Šé™ï¼Œä¸¦ç”¨ HTTPS é–‹å•Ÿï¼ˆä¾‹å¦‚ GitHub Pagesï¼‰ã€‚";
    }
  }

  btnLocate.addEventListener("click", async () => {
    try{
      await locate();
      await refreshAll();
    } catch(e){
      elStatus.textContent = "å®šä½å¤±æ•—ï¼šè«‹å…è¨±ä½ç½®æ¬Šé™ã€‚";
    }
  });
  btnRefresh.addEventListener("click", refreshAll);
  elRadius.addEventListener("change", refreshAll);
  elLang.addEventListener("change", refreshAll);
  elRefreshSec.addEventListener("change", startTimer);

  // Register service worker for installable PWA
  if ("serviceWorker" in navigator){
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }

  init();
})();
</script>
</body>
</html>